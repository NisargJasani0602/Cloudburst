name: Build and Push Docker Image

on:
  push:
    branches:
      - 'release/**'

jobs:
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Login to Docker Hub
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 2. Setup Variable
      # We calculate IMAGE_NAME_LC once and save it to GITHUB_ENV so all steps can use it.
      - name: Setup Image Name
        run: |
          IMAGE_NAME_LC=$(echo "${{ secrets.DOCKERHUB_USERNAME }}/cloudburst" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME_LC=$IMAGE_NAME_LC" >> $GITHUB_ENV

      # 3. Build (But DO NOT Push)
      # We build using the variable we just set.
      - name: Build Docker Image
        run: |
          docker build \
            -t $IMAGE_NAME_LC:latest \
            -t $IMAGE_NAME_LC:0.1 \
            -t $IMAGE_NAME_LC:${{ github.sha }} \
            ./coffee-project-main

      # 4. Security Scan (Trivy)
      # This runs between Build and Push.
      # It fails (exit-code 1) if CRITICAL vulnerabilities are found.
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: '${{ env.IMAGE_NAME_LC }}:${{ github.sha }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL'

      # 5. Push (Only if Scan Passed)
      - name: Push to Docker Hub
        if: success()
        run: |
          echo "Scan passed. Pushing images..."
          docker push $IMAGE_NAME_LC:latest
          docker push $IMAGE_NAME_LC:0.1
          docker push $IMAGE_NAME_LC:${{ github.sha }}