name: CloudBurst - Scale Up (VCL)

on:
  workflow_dispatch:          # manual trigger from GitHub UI
  repository_dispatch:        # optional external trigger (e.g., webhook)
    types: [cloudburst_burst]

jobs:
  burst:
    name: Scale Up CloudBurst Deployment on VCL
    runs-on: self-hosted      # your VCL GitHub runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl for VCL cluster
        run: |
          mkdir -p "$HOME/.kube"
          echo "${{ secrets.NEW_KUBECONFIG_CONTENTS }}" > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"
          echo "Current context:"
          kubectl config current-context
          echo "Cluster nodes:"
          kubectl get nodes -o wide

      - name: Burst CloudBurst on VCL (scale up)
        run: |
          echo "Scaling CloudBurst deployment in VCL cluster to 6 replicas..."
          kubectl -n cloudburst scale deployment cloudburst --replicas=6

      - name: Wait for rollout to finish
        run: |
          echo "Waiting for CloudBurst rollout..."
          kubectl -n cloudburst rollout status deployment/cloudburst --timeout=90s
          echo "Current CloudBurst pods on VCL:"
          kubectl -n cloudburst get pods -o wide

      - name: Notify
        run: echo "✅ VCL Burst Triggered — CloudBurst scaled UP to 6 replicas on VCL."
